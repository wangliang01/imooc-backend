(()=>{"use strict";var e={375:(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r=o(496),n=o(448),s=o(178),a=d(o(829)),i=o(415),u=d(o(136)),c=d(o(729));function d(e){return e&&e.__esModule?e:{default:e}}t.default=new class{constructor(){}async register(e){const t=await new r.LoginValidator(e).validate();if(await(0,n.getValue)(t.sid)!==t.code)throw new s.HttpException("验证码错误",10001);if(await u.default.findOne({username:t.username}))throw new s.HttpException("用户已存在",10002);if(await u.default.findOne({nickname:t.nickname}))throw new s.HttpException("昵称已存在",10003);const o=c.default.genSaltSync(10),a=c.default.hashSync(t.password,o);await u.default.create({username:t.username,password:a,nickname:t.nickname}),(0,i.success)(e,null,"注册成功")}async login(e){const t=await new r.LoginValidator(e).validate();if((await(0,n.getValue)(t.sid)).toLowerCase()!==t.code.toLowerCase())throw new s.HttpException("验证码错误");const o=await u.default.findOne({username:t.username});if(!o)throw new s.HttpException("账号或者密码错误");if(!o.checkPassword(t.password))throw new s.HttpException("账号或者密码错误");const c=a.default.sign({uid:1},process.env.JWT_SECRET,{expiresIn:"1d"});(0,i.success)(e,{token:c})}async index(e){e.body={name:"user",path:"/user",meta:{title:"用户中心!!!!!"}}}}},617:(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r,n=(r=o(753))&&r.__esModule?r:{default:r},s=o(448);t.default=new class{constructor(){}async getCaptcha(e){const{text:t,data:o}=n.default.create({size:4,fontSize:50,width:124,height:38,noise:2,color:!0,ignoreChars:"0o1i",background:"#fff"}),r=e.request.query.sid;await(0,s.setValue)(r,t.toLowerCase(),600),(0,s.getValue)(r).then((e=>{console.log(e)})),e.set("Content-Type","image/svg+xml"),e.body=o}async getCaptchaV2(e){const{text:t,data:o}=n.default.create({size:4,fontSize:50,width:124,height:38,noise:2,color:!0,ignoreChars:"0o1i",background:"#f0f0f0"});e.session.captcha=t.toLowerCase(),e.set("Content-Type","image/svg+xml"),e.body=o}}},807:(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;o(178);t.default=async(e,t)=>{try{await t()}catch(t){if(401===t.status)return e.status=401,void(e.body={msg:"用户未授权，请在访问时在header中加入Authorization",code:401,data:null});e.status=500,e.body={msg:"服务器异常，请稍后重试",code:999,data:null}}}},136:(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r=s(o(173)),n=s(o(729));function s(e){return e&&e.__esModule?e:{default:e}}const a=new r.default.Schema({username:{type:String,required:!0,unique:!0},nickname:{type:String,required:!1},password:{type:String,required:!0},email:{type:String,required:!1,unique:!0}}),i=r.default.model("users",a);i.prototype.checkPassword=function(e){return n.default.compareSync(e,this.password)};t.default=i},647:(e,t,o)=>{e=o.nmd(e),Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r=i(o(146)),n=(i(o(733)),i(o(928))),s=(i(o(897)),i(o(258))),a=i(o(110));function i(e){return e&&e.__esModule?e:{default:e}}const u=[s.default,a.default];n.default.join(process.cwd(),"src/router");t.default=(0,r.default)(...u)},258:(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r=s(o(733)),n=s(o(375));function s(e){return e&&e.__esModule?e:{default:e}}const a=new r.default({prefix:"/api"});a.post("/register",n.default.register),a.post("/login",n.default.login),a.post("/forget",(async e=>{}));t.default=a},110:(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r=s(o(733)),n=s(o(617));function s(e){return e&&e.__esModule?e:{default:e}}const a=new r.default({prefix:"/api/public"});a.get("/captcha",n.default.getCaptchaV2);t.default=a},173:(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r,n=(r=o(37))&&r.__esModule?r:{default:r};console.log("db url:",process.env.DB_URL),n.default.connect(process.env.DB_URL,{useNewUrlParser:!0,useUnifiedTopology:!0}),n.default.connection.on("connected",(()=>{console.log("Mongoose connected to db")})),n.default.connection.on("error",(e=>{console.log("Mongoose connection error: ",e)})),n.default.connection.on("disconnected",(()=>{console.log("Mongoose disconnected")}));t.default=n.default},260:(e,t,o)=>{o(818).config();const r=o(896),n=".env";let s;r.existsSync(n)&&o(818).config({path:n}),console.log("process.env.NODE_ENV","production"),s=".env.prod",s&&r.existsSync(s)&&o(818).config({path:s}),console.log(process.env.PORT)},415:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.success=function(e,t=null,o="success"){e.body={code:200,msg:o,data:t}}},178:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.HttpException=void 0;class o extends Error{constructor(e="参数错误",t=1e4,o=400){super(),this.msg=e,this.errorCode=t,this.code=o}}t.HttpException=o},558:(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.KoaValidator=void 0;var r=o(622),n=o(178);t.KoaValidator=class{constructor(e,t){this.ctx=e,this.rules=t,this.params=this.integrationParameter(),this.validateSchema=(0,r.object)(t)}integrationParameter(){let e={},t=this.ctx.header,o=this.ctx.params,r=this.ctx.query,n=this.ctx.request.body;return Object.keys(this.rules).forEach((s=>{t[s]?e[s]=t[s]:o[s]?e[s]=o[s]:r[s]?e[s]=r[s]:n[s]&&(e[s]=n[s])})),e}async validate(){try{return await this.validateSchema.validate(this.params,{abortEarly:!1,stripUnknown:!0})}catch(e){throw new n.HttpException(e.errors[0].message,10001)}}}},448:(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0,t.getHValue=function(e){if(null==e||""===e)return;return n.hGetAll(e)},t.getValue=function(e){if(null==e||""===e)return;return n.get(e)},t.setValue=function(e,t,o){if(null==e||""===e)return;"string"==typeof t?o?n.set(e,t,"EX",o):n.set(e,t):Object.keys(t).forEach((function(o){n.hSet(e,o,t[o])}))};var r=o(835);console.log("redis url:",process.env.REDIS_URL),console.log("PORT",process.env.PORT);const n=(0,r.createClient)({url:process.env.REDIS_URL});n.connect(),n.on("error",(e=>{console.error("Redis Client Error",e)})),n.on("close",(()=>{console.log("Redis client disconnected")})),n.on("end",(()=>{console.log("Redis client connection ended")}));t.default=n},496:(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.LoginValidator=void 0;var r=o(558),n=function(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var o=s(t);if(o&&o.has(e))return o.get(e);var r={__proto__:null},n=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var a in e)if("default"!==a&&{}.hasOwnProperty.call(e,a)){var i=n?Object.getOwnPropertyDescriptor(e,a):null;i&&(i.get||i.set)?Object.defineProperty(r,a,i):r[a]=e[a]}return r.default=e,o&&o.set(e,r),r}(o(622));function s(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,o=new WeakMap;return(s=function(e){return e?o:t})(e)}class a extends r.KoaValidator{constructor(e){super(e,{username:n.string().required({message:"请输入用户名"}).email({message:"请输入正确的邮箱"}),nickname:n.string().optional(),password:n.string().required({message:"请输入密码"}).min(6,{message:"密码不能少于6位"}),code:n.string().required({message:"请输入验证码"}).min(4,{message:"验证码只支持4位"}).max(4,{message:"验证码只支持4位"}),sid:n.string().required({message:"请输入sid"})})}}t.LoginValidator=a},695:e=>{e.exports=require("@koa/cors")},729:e=>{e.exports=require("bcryptjs")},818:e=>{e.exports=require("dotenv")},829:e=>{e.exports=require("jsonwebtoken")},101:e=>{e.exports=require("koa")},216:e=>{e.exports=require("koa-body")},146:e=>{e.exports=require("koa-combine-routers")},316:e=>{e.exports=require("koa-compose")},388:e=>{e.exports=require("koa-compress")},721:e=>{e.exports=require("koa-helmet")},546:e=>{e.exports=require("koa-json")},29:e=>{e.exports=require("koa-jwt")},733:e=>{e.exports=require("koa-router")},720:e=>{e.exports=require("koa-session")},694:e=>{e.exports=require("koa-static")},37:e=>{e.exports=require("mongoose")},835:e=>{e.exports=require("redis")},897:e=>{e.exports=require("require-directory")},753:e=>{e.exports=require("svg-captcha")},622:e=>{e.exports=require("yup")},896:e=>{e.exports=require("fs")},928:e=>{e.exports=require("path")}},t={};function o(r){var n=t[r];if(void 0!==n)return n.exports;var s=t[r]={id:r,loaded:!1,exports:{}};return e[r](s,s.exports,o),s.loaded=!0,s.exports}o.nmd=e=>(e.paths=[],e.children||(e.children=[]),e),o(260);var r=h(o(928)),n=h(o(101)),s=o(216),a=h(o(695)),i=h(o(546)),u=h(o(721)),c=h(o(694)),d=h(o(647)),l=h(o(316)),p=h(o(388)),f=h(o(720)),g=h(o(807)),v=h(o(29));function h(e){return e&&e.__esModule?e:{default:e}}const y=new n.default;y.use(g.default),y.keys=[process.env.KOA_SESSION_KEYS];const _={key:process.env.KOA_SESSION_KEY,maxAge:+process.env.KOA_SESSION_MAX_AGE,autoCommit:!0,overwrite:!0,httpOnly:!0,signed:!0,rolling:!1,renew:!1},m=(0,l.default)([(0,s.koaBody)({multipart:!0}),(0,a.default)(),(0,i.default)(),(0,v.default)({secret:process.env.JWT_SECRET}).unless({path:[/^\/api\/login/,/^\/api\/register/,/^\/api\/public/]}),(0,f.default)(_,y),(0,u.default)(),(0,c.default)(r.default.join(__dirname,"../public")),(0,d.default)()]);y.use(m),y.use((0,p.default)());let w=process.env.PORT||3e3;y.listen(w,(()=>{console.log(`server is running at http://localhost:${w}`)}))})();